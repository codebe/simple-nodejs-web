<!DOCTYPE html>  <html> <head>   <title>twig.expression.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="twig.compiler.html">                 twig.compiler.js               </a>                                           <a class="source" href="twig.core.html">                 twig.core.js               </a>                                           <a class="source" href="twig.exports.html">                 twig.exports.js               </a>                                           <a class="source" href="twig.expression.html">                 twig.expression.js               </a>                                           <a class="source" href="twig.expression.operator.html">                 twig.expression.operator.js               </a>                                           <a class="source" href="twig.fills.html">                 twig.fills.js               </a>                                           <a class="source" href="twig.filters.html">                 twig.filters.js               </a>                                           <a class="source" href="twig.functions.html">                 twig.functions.js               </a>                                           <a class="source" href="twig.lib.html">                 twig.lib.js               </a>                                           <a class="source" href="twig.logic.html">                 twig.logic.js               </a>                                           <a class="source" href="twig.module.html">                 twig.module.js               </a>                                           <a class="source" href="twig.tests.html">                 twig.tests.js               </a>                                           <a class="source" href="twig.html">                 twig.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               twig.expression.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>Twig.js
Copyright (c) 2011-2012 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>twig.expression.js</h2>

<p>This file handles tokenizing, compiling and parsing expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Namespace for expression handling.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Reserved word that can&#39;t be used as variable names.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">reservedWords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span>
    <span class="p">];</span>

    <span class="cm">/**</span>
<span class="cm">     * The type of tokens used in expressions.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">comma</span><span class="o">:</span>      <span class="s1">&#39;Twig.expression.type.comma&#39;</span><span class="p">,</span>
        <span class="nx">expression</span><span class="o">:</span> <span class="s1">&#39;Twig.expression.type.expression&#39;</span><span class="p">,</span>
        <span class="nx">operator</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">unary</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type.operator.unary&#39;</span><span class="p">,</span>
            <span class="nx">binary</span><span class="o">:</span> <span class="s1">&#39;Twig.expression.type.operator.binary&#39;</span>
        <span class="p">},</span>
        <span class="nx">string</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.string&#39;</span><span class="p">,</span>
        <span class="nx">bool</span><span class="o">:</span>       <span class="s1">&#39;Twig.expression.type.bool&#39;</span><span class="p">,</span>
        <span class="nx">array</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type.array.start&#39;</span><span class="p">,</span>
            <span class="nx">end</span><span class="o">:</span>    <span class="s1">&#39;Twig.expression.type.array.end&#39;</span>
        <span class="p">},</span>
        <span class="nx">object</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type.object.start&#39;</span><span class="p">,</span>
            <span class="nx">end</span><span class="o">:</span>    <span class="s1">&#39;Twig.expression.type.object.end&#39;</span>
        <span class="p">},</span>
        <span class="nx">parameter</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type.parameter.start&#39;</span><span class="p">,</span>
            <span class="nx">end</span><span class="o">:</span>    <span class="s1">&#39;Twig.expression.type.parameter.end&#39;</span>
        <span class="p">},</span>
        <span class="nx">key</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">period</span><span class="o">:</span>   <span class="s1">&#39;Twig.expression.type.key.period&#39;</span><span class="p">,</span>
            <span class="nx">brackets</span><span class="o">:</span> <span class="s1">&#39;Twig.expression.type.key.brackets&#39;</span>
        <span class="p">},</span>
        <span class="nx">filter</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.filter&#39;</span><span class="p">,</span>
        <span class="nx">_function</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type._function&#39;</span><span class="p">,</span>
        <span class="nx">variable</span><span class="o">:</span>   <span class="s1">&#39;Twig.expression.type.variable&#39;</span><span class="p">,</span>
        <span class="nx">number</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.number&#39;</span><span class="p">,</span>
        <span class="nx">_null</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.null&#39;</span><span class="p">,</span>
        <span class="nx">test</span><span class="o">:</span>       <span class="s1">&#39;Twig.expression.type.test&#39;</span>
    <span class="p">};</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>What can follow an expression (in general)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">operations</span><span class="o">:</span> <span class="p">[</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">unary</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">binary</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">comma</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">test</span>
        <span class="p">],</span>
        <span class="nx">expressions</span><span class="o">:</span> <span class="p">[</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">_function</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">bool</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">variable</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">number</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">_null</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span>
        <span class="p">]</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Most expressions allow a '.' or '[' after them, so we provide a convenience set</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Some commonly used compile and parse functions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">compile</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">push_both</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">parse</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">push_value</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The regular expressions and compile/parse logic used to match tokens in expressions.</p>

<p>Properties:</p>

<pre><code> type:  The type of expression this matches

 regex: One or more regular expressions that matche the format of the token.

 next:  Valid tokens that can occur next in the expression.
</code></pre>

<p>Functions:</p>

<pre><code> compile: A function that compiles the raw regular expression match into a token.

 parse:   A function that parses the compiled token into output.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">definitions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">test</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^is\s+(not)?\s*([a-zA-Z_][a-zA-Z0-9_]*)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">filter</span>   <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">modifier</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                    <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">modifier</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">comma</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Match a comma</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^,/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">stack_token</span><span class="p">;</span>

                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>pop tokens off the stack until the start of the object</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span><span class="p">(;</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">stack_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">stack_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span>
                            <span class="o">||</span> <span class="nx">stack_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span>
                            <span class="o">||</span> <span class="nx">stack_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack_token</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack_token</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Match (, anything but ), )</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\(([^\)]+)\)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

                <span class="kd">var</span> <span class="nx">sub_stack</span> <span class="o">=</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="nx">sub_stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sub_stack</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">binary</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Match any of +, <em>, /, -, %, ~, &lt;, &lt;=, >, >=, !=, ==, *</em>, ?, :, and, or, not</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/(^[\+\-~%\?\:]|^[!=]==?|^[!&lt;&gt;]=?|^\*\*?|^\/\/?|^and\s+|^or\s+|^in\s+|^not in\s+|^\.\.)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">unary</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
                    <span class="nx">operator</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>

                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Operator: &quot;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="s2">&quot; from &quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                       <span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">unary</span> <span class="o">||</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">binary</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                            <span class="p">(</span>
                                <span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span> <span class="o">&amp;&amp;</span>
                                 <span class="nx">operator</span><span class="p">.</span><span class="nx">precidence</span>    <span class="o">&gt;=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">precidence</span><span class="p">)</span> <span class="o">||</span>

                                <span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">rightToLeft</span> <span class="o">&amp;&amp;</span>
                                 <span class="nx">operator</span><span class="p">.</span><span class="nx">precidence</span>    <span class="o">&gt;</span>  <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">precidence</span><span class="p">)</span>
                            <span class="p">)</span>
                       <span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                     <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">temp</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Check if this is a ternary or object key being set</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Continue as normal for a ternary</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>This is not a ternary so we push the token to the output where it can be handled
  when the assocated object is closed.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="kd">var</span> <span class="nx">key_token</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">key_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span> <span class="o">||</span>
                                <span class="nx">key_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">variable</span> <span class="o">||</span>
                                <span class="nx">key_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key_token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unexpected value before &#39;:&#39; of &quot;</span> <span class="o">+</span> <span class="nx">key_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nx">key_token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">operator</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>handle ternary ':' operator</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">unary</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Match any of not</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/(^not\s+)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
                    <span class="nx">operator</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>

                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Operator: &quot;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="s2">&quot; from &quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                       <span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">unary</span> <span class="o">||</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">binary</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                            <span class="p">(</span>
                                <span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span> <span class="o">&amp;&amp;</span>
                                 <span class="nx">operator</span><span class="p">.</span><span class="nx">precidence</span>    <span class="o">&gt;=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">precidence</span><span class="p">)</span> <span class="o">||</span>

                                <span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">rightToLeft</span> <span class="o">&amp;&amp;</span>
                                 <span class="nx">operator</span><span class="p">.</span><span class="nx">precidence</span>    <span class="o">&gt;</span>  <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">precidence</span><span class="p">)</span>
                            <span class="p">)</span>
                       <span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                     <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">temp</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">operator</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a string. This is anything between a pair of single or double quotes.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>See: http://blog.stevenlevithan.com/archives/match-quoted-string</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^([&quot;&#39;])(?:(?=(\\?))\2.)*?\1/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Remove the quotes from the string</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;\\&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;\\&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;String value: &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push_value</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a parameter set start.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\(/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">end</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push_both</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a parameter set end.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">stack_token</span><span class="p">;</span>
                <span class="nx">stack_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">stack_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack_token</span><span class="p">);</span>
                    <span class="nx">stack_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Move contents of parens into preceding filter</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">param_stack</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Add token to arguments stack</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">param_stack</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="nx">param_stack</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Get the token preceding the parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">_function</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">test</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected filter or function before parameters, got &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nx">param_stack</span><span class="p">;</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">new_array</span> <span class="o">=</span> <span class="p">[],</span>
                    <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Push values into the array until the start of the array</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">new_array</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">array_ended</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected end of parameter set.&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">new_array</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match an array start.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\[/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">end</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push_both</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match an array end.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\]/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nx">stack_token</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>pop tokens off the stack until the start of the object</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span><span class="p">(;</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">stack_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">stack_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack_token</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">new_array</span> <span class="o">=</span> <span class="p">[],</span>
                    <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Push values into the array until the start of the array</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">new_array</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">array_ended</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected end of array.&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">new_array</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Token that represents the start of a hash map '}'</p>

<p>Hash maps take the form:
   { "key": 'value', "another_key": item }</p>

<p>Keys must be quoted (either single or double) and values can be any expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\{/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">end</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push_both</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Token that represents the end of a Hash Map '}'</p>

<p>This is where the logic for building the internal
representation of a hash map is defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\}/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="nx">stack_token</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>pop tokens off the stack until the start of the object</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">for</span><span class="p">(;</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">stack_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">stack_token</span> <span class="o">&amp;&amp;</span> <span class="nx">stack_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack_token</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">end_token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">new_object</span> <span class="o">=</span> <span class="p">{},</span>
                    <span class="nx">object_ended</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
                    <span class="nx">token_key</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
                    <span class="nx">has_value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Push values into the array until the start of the object</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">object_ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">binary</span> <span class="o">||</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">unary</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">has_value</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Missing value for key &#39;&quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;&#39; in object definition.&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">new_object</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Preserve the order that elements are added to the map
This is necessary since JavaScript objects don't
guarantee the order of keys</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">new_object</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">new_object</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">new_object</span><span class="p">.</span><span class="nx">_keys</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>reset value check</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="nx">has_value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">has_value</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object_ended</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unexpected end of object.&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">new_object</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Token representing a filter</p>

<p>Filters can follow any expression and take the form:
   expression|filter(optional, args)</p>

<p>Filter parsing is done in the Twig.filters namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>match a | then a letter or _, then any number of letters, numbers, _ or -</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\|\s?([a-zA-Z_][a-zA-Z0-9_\-]*)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                    <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">params</span><span class="p">]));</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">_function</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>match any letter or _, then any number of letters, numbers, _ or - followed by (</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">transform</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;(&#39;</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>cleanup token</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">fn</span>     <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">fn</span><span class="p">,</span>
                    <span class="nx">value</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">fn</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Get the function from the built-in functions</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">fn</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>

                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">context</span><span class="p">[</span><span class="nx">fn</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Get the function from the user/context defined functions</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">context</span><span class="p">[</span><span class="nx">fn</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>

                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="nx">fn</span> <span class="o">+</span> <span class="s1">&#39; function does not exist and is not defined in the context&#39;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Token representing a variable.</p>

<p>Variables can contain letters, numbers, underscores and
dashes, but must start with a letter or underscore.</p>

<p>Variables are retrieved from the render context and take
the value of 'undefined' if the given variable doesn't
exist in the context.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">variable</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>match any letter or _, then any number of letters, numbers, _ or -</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^[a-zA-Z_][a-zA-Z0-9_]*/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span>
            <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">reservedWords</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Get the variable from the context</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">context</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">],</span> <span class="nx">context</span><span class="p">);</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\.([a-zA-Z0-9_]+)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
                    <span class="nx">object</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                    <span class="nx">value</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">strict_variables</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t access a key &quot;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot; on an null or undefined object.&quot;</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="kd">var</span> <span class="nx">capitalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);};</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Get the variable from the context</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">object</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="o">+</span><span class="nx">capitalize</span><span class="p">(</span><span class="nx">key</span><span class="p">)]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="o">+</span><span class="nx">capitalize</span><span class="p">(</span><span class="nx">key</span><span class="p">)];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">[</span><span class="s2">&quot;is&quot;</span><span class="o">+</span><span class="nx">capitalize</span><span class="p">(</span><span class="nx">key</span><span class="p">)]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="s2">&quot;is&quot;</span><span class="o">+</span><span class="nx">capitalize</span><span class="p">(</span><span class="nx">key</span><span class="p">)];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">params</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\[([^\]]*)\]/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations_extended</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The expression stack for the key</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">({</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span>
                <span class="p">}).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Evaluate key</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">key</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">object</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                    <span class="nx">value</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">strict_variables</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t access a key &quot;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot; on an null or undefined object.&quot;</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Get the variable from the context</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">object</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">params</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a null value.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">_null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>match a number</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^null/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push_value</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a number (integer or decimal)</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">number</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>match a number</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\-?\d+(\.\d+)?/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push_value</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a boolean</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">bool</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^(true|false)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">);</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push_value</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="cm">/**</span>
<span class="cm">     * Resolve a context value.</span>
<span class="cm">     *</span>
<span class="cm">     * If the value is a function, it is executed with a context parameter.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} key The context object key.</span>
<span class="cm">     * @param {Object} context The render context.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">params</span> <span class="o">||</span> <span class="p">[]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Registry for logic handlers.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Define a new expression type, available at Twig.logic.type.{type}</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} type The name of the new type.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">extendType</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Twig.expression.type.&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Extend the expression parsing functionality with a new definition.</span>
<span class="cm">     *</span>
<span class="cm">     * Token definitions follow this format:</span>
<span class="cm">     *  {</span>
<span class="cm">     *      type:     One of Twig.expression.type.[type], either pre-defined or added using</span>
<span class="cm">     *                    Twig.expression.extendType</span>
<span class="cm">     *</span>
<span class="cm">     *      next:     Array of types from Twig.expression.type that can follow this token,</span>
<span class="cm">     *</span>
<span class="cm">     *      regex:    A regex or array of regex&#39;s that should match the token.</span>
<span class="cm">     *</span>
<span class="cm">     *      compile: function(token, stack, output) called when this token is being compiled.</span>
<span class="cm">     *                   Should return an object with stack and output set.</span>
<span class="cm">     *</span>
<span class="cm">     *      parse:   function(token, stack, context) called when this token is being parsed.</span>
<span class="cm">     *                   Should return an object with stack and context set.</span>
<span class="cm">     *  }</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} definition A token definition.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to extend logic definition. No type provided for &quot;</span> <span class="o">+</span> <span class="nx">definition</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Extend with built-in expressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Break an expression into tokens defined in Twig.expression.definitions.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} expression The string to tokenize.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Array} An array of tokens.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">tokenize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Keep an offset of the location in the expression for error messages.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">exp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>The valid next tokens of the previous token</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">next</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Match information</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">type</span><span class="p">,</span> <span class="nx">regex</span><span class="p">,</span> <span class="nx">regex_array</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>The possible next token for the match</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">token_next</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Has a match been found from the definitions</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">match_found</span><span class="p">,</span> <span class="nx">invalid_matches</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">match_function</span><span class="p">;</span>

        <span class="nx">match_function</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span>
                <span class="nx">string</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                <span class="nx">offset</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>

            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.tokenize&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Matched a &quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="s2">&quot; regular expression of &quot;</span><span class="p">,</span> <span class="nx">match</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">invalid_matches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
                    <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot; cannot follow a &quot;</span> <span class="o">+</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">type</span> <span class="o">+</span>
                           <span class="s2">&quot; at template:&quot;</span> <span class="o">+</span> <span class="nx">exp_offset</span> <span class="o">+</span> <span class="s2">&quot; near &#39;&quot;</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s2">&quot;...&#39;&quot;</span>
                <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Not a match, don't change the expression</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Validate the token if a validation function is provided</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">validate</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">validate</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="p">}</span>

            <span class="nx">invalid_matches</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                <span class="nx">type</span><span class="o">:</span>  <span class="nx">type</span><span class="p">,</span>
                <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="nx">match</span><span class="o">:</span> <span class="nx">match</span>
            <span class="p">});</span>

            <span class="nx">match_found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">next</span> <span class="o">=</span> <span class="nx">token_next</span><span class="p">;</span>
            <span class="nx">exp_offset</span> <span class="o">+=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Does the token need to return output back to the expression string
e.g. a function match of cycle( might return the '(' back to the expression
This allows look-ahead to differentiate between token types (e.g. functions and variable names)</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">transform</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">transform</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.expression.tokenize&quot;</span><span class="p">,</span> <span class="s2">&quot;Tokenizing expression &quot;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">);</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">expression</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">token_next</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">next</span><span class="p">;</span>
                    <span class="nx">regex</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">regex</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Twig.log.trace("Checking type ", type, " on ", expression);</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">regex</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">regex_array</span> <span class="o">=</span> <span class="nx">regex</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">regex_array</span> <span class="o">=</span> <span class="p">[</span><span class="nx">regex</span><span class="p">];</span>
                    <span class="p">}</span>

                    <span class="nx">match_found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nx">regex_array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">regex</span> <span class="o">=</span> <span class="nx">regex_array</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                        <span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">regex</span><span class="p">,</span> <span class="nx">match_function</span><span class="p">);</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>An expression token has been matched. Break the for loop and start trying to
 match the next template (if expression isn't empty.)</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">match_found</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match_found</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">invalid_matches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="nx">invalid_matches</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; OR &quot;</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to parse &#39;&quot;</span> <span class="o">+</span> <span class="nx">expression</span> <span class="o">+</span> <span class="s2">&quot;&#39; at template position&quot;</span> <span class="o">+</span> <span class="nx">exp_offset</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.tokenize&quot;</span><span class="p">,</span> <span class="s2">&quot;Tokenized to &quot;</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Compile an expression token.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} raw_token The uncompiled token.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} The compiled token.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">raw_token</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">raw_token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Tokenize expression</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">expression</span><span class="p">),</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">stack</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiling &quot;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Push tokens into RPN stack using the Sunting-yard algorithm
See http://en.wikipedia.org/wiki/Shunting<em>yard</em>algorithm</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">while</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>

            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiling &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Compile the template</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span> <span class="o">&amp;&amp;</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>

            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Stack is&quot;</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Output is&quot;</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">while</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Final output is&quot;</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>

        <span class="nx">raw_token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">output</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">raw_token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">raw_token</span><span class="p">;</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Parse an RPN expression stack within a context.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Array} tokens An array of compiled expression tokens.</span>
<span class="cm">     * @param {Object} context The render context to parse the tokens with.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} The result of parsing all the tokens. The result</span>
<span class="cm">     *                  can be anything, String, Array, Object, etc... based on</span>
<span class="cm">     *                  the given expression.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>If the token isn't an array, make it one.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">tokens</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="nx">tokens</span><span class="p">];</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>The output stack</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="nx">tokens</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>

            <span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span> <span class="o">&amp;&amp;</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Pop the final value off the stack</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>

<span class="p">})(</span> <span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">}</span> <span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 