<!DOCTYPE html>  <html> <head>   <title>twig.logic.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="twig.compiler.html">                 twig.compiler.js               </a>                                           <a class="source" href="twig.core.html">                 twig.core.js               </a>                                           <a class="source" href="twig.exports.html">                 twig.exports.js               </a>                                           <a class="source" href="twig.expression.html">                 twig.expression.js               </a>                                           <a class="source" href="twig.expression.operator.html">                 twig.expression.operator.js               </a>                                           <a class="source" href="twig.fills.html">                 twig.fills.js               </a>                                           <a class="source" href="twig.filters.html">                 twig.filters.js               </a>                                           <a class="source" href="twig.functions.html">                 twig.functions.js               </a>                                           <a class="source" href="twig.lib.html">                 twig.lib.js               </a>                                           <a class="source" href="twig.logic.html">                 twig.logic.js               </a>                                           <a class="source" href="twig.module.html">                 twig.module.js               </a>                                           <a class="source" href="twig.tests.html">                 twig.tests.js               </a>                                           <a class="source" href="twig.html">                 twig.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               twig.logic.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>Twig.js
Copyright (c) 2011-2012 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>twig.logic.js</h2>

<p>This file handles tokenizing, compiling and parsing logic tokens. {% ... %}</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Namespace for logic handling.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Logic token types.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">if_</span><span class="o">:</span>       <span class="s1">&#39;Twig.logic.type.if&#39;</span><span class="p">,</span>
        <span class="nx">endif</span><span class="o">:</span>     <span class="s1">&#39;Twig.logic.type.endif&#39;</span><span class="p">,</span>
        <span class="nx">for_</span><span class="o">:</span>      <span class="s1">&#39;Twig.logic.type.for&#39;</span><span class="p">,</span>
        <span class="nx">endfor</span><span class="o">:</span>    <span class="s1">&#39;Twig.logic.type.endfor&#39;</span><span class="p">,</span>
        <span class="nx">else_</span><span class="o">:</span>     <span class="s1">&#39;Twig.logic.type.else&#39;</span><span class="p">,</span>
        <span class="nx">elseif</span><span class="o">:</span>    <span class="s1">&#39;Twig.logic.type.elseif&#39;</span><span class="p">,</span>
        <span class="nx">set</span><span class="o">:</span>       <span class="s1">&#39;Twig.logic.type.set&#39;</span><span class="p">,</span>
        <span class="nx">filter</span><span class="o">:</span>    <span class="s1">&#39;Twig.logic.type.filter&#39;</span><span class="p">,</span>
        <span class="nx">endfilter</span><span class="o">:</span> <span class="s1">&#39;Twig.logic.type.endfilter&#39;</span><span class="p">,</span>
        <span class="nx">block</span><span class="o">:</span>     <span class="s1">&#39;Twig.logic.type.block&#39;</span><span class="p">,</span>
        <span class="nx">endblock</span><span class="o">:</span>  <span class="s1">&#39;Twig.logic.type.endblock&#39;</span><span class="p">,</span>
        <span class="nx">extends_</span><span class="o">:</span>  <span class="s1">&#39;Twig.logic.type.extends&#39;</span><span class="p">,</span>
        <span class="nx">use</span><span class="o">:</span>       <span class="s1">&#39;Twig.logic.type.use&#39;</span><span class="p">,</span>
        <span class="nx">include</span><span class="o">:</span>  <span class="s1">&#39;Twig.logic.type.include&#39;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Regular expressions for handling logic tokens.</p>

<p>Properties:</p>

<pre><code> type:  The type of expression this matches

 regex: A regular expression that matches the format of the token

 next:  What logic tokens (if any) pop this token off the logic stack. If empty, the
        logic token is assumed to not require an end tag and isn't push onto the stack.

 open:  Does this tag open a logic expression or is it standalone. For example,
        {% endif %} cannot exist without an opening {% if ... %} tag, so open = false.
</code></pre>

<p>Functions:</p>

<pre><code> compile: A function that handles compiling the token into an output token ready for
          parsing with the parse function.

 parse:   A function that parses the compiled token into output (HTML / whatever the
          template represents).
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">definitions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * If type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% if expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">if_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^if\s+([^\s].+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">elseif</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Parse the expression</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Start a new logic chain</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">chain</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>parse if output</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Else if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% elseif expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">elseif</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^elseif\s+([^\s].*)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">elseif</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">chain</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">])</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">chain</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>parse if output</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Else if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% elseif expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^else$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfor</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endif %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endif$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * For type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% for expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">for_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^for\s+([a-zA-Z0-9_,\s]+)\s+in\s+([^\s].*?)(?:\s+if\s+([^\s].*))?$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfor</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">key_value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="nx">conditional</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                    <span class="nx">kv_split</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">key_value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">kv_split</span> <span class="o">=</span> <span class="nx">key_value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">kv_split</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span> <span class="o">=</span> <span class="nx">kv_split</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span> <span class="o">=</span> <span class="nx">kv_split</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid expression in for loop: &quot;</span> <span class="o">+</span> <span class="nx">key_value</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span> <span class="o">=</span> <span class="nx">key_value</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Valid expressions for a for loop
  for item     in expression
  for key,item in expression</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">expression</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Compile the conditional (if available)</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">conditional</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">conditional</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">conditional</span>
                    <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">continue_chain</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Parse expression</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span>
					<span class="nx">len</span><span class="p">,</span>
					<span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="nx">keyset</span><span class="p">,</span>
                    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
                    <span class="nx">conditional</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">conditional</span><span class="p">,</span>
                    <span class="nx">buildLoop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">isConditional</span> <span class="o">=</span> <span class="nx">conditional</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">;</span>
                        <span class="k">return</span> <span class="p">{</span>
                            <span class="nx">index</span><span class="o">:</span> <span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                            <span class="nx">index0</span><span class="o">:</span> <span class="nx">index</span><span class="p">,</span>
                            <span class="nx">revindex</span><span class="o">:</span> <span class="nx">isConditional</span><span class="o">?</span><span class="kc">undefined</span><span class="o">:</span><span class="nx">len</span><span class="o">-</span><span class="nx">index</span><span class="p">,</span>
                            <span class="nx">revindex0</span><span class="o">:</span> <span class="nx">isConditional</span><span class="o">?</span><span class="kc">undefined</span><span class="o">:</span><span class="nx">len</span><span class="o">-</span><span class="nx">index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="nx">first</span><span class="o">:</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="mi">0</span><span class="p">),</span>
                            <span class="nx">last</span><span class="o">:</span> <span class="nx">isConditional</span><span class="o">?</span><span class="kc">undefined</span><span class="o">:</span><span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                            <span class="nx">length</span><span class="o">:</span> <span class="nx">isConditional</span><span class="o">?</span><span class="kc">undefined</span><span class="o">:</span><span class="nx">len</span><span class="p">,</span>
                            <span class="nx">parent</span><span class="o">:</span> <span class="nx">context</span>
                        <span class="p">};</span>
                    <span class="p">},</span>
                    <span class="nx">loop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">inner_context</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">lib</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

                        <span class="nx">inner_context</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">inner_context</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
                        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Loop object</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">inner_context</span><span class="p">.</span><span class="nx">loop</span> <span class="o">=</span> <span class="nx">buildLoop</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">len</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">conditional</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
                            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">[</span><span class="nx">conditional</span><span class="p">,</span> <span class="nx">inner_context</span><span class="p">]))</span>
                        <span class="p">{</span>
                            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">inner_context</span><span class="p">]));</span>
                            <span class="nx">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">};</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">len</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                    <span class="nx">result</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>

                        <span class="nx">loop</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">keyset</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_keys</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">keyset</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                    <span class="p">}</span>
					<span class="nx">len</span> <span class="o">=</span> <span class="nx">keyset</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                    <span class="nx">keyset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Ignore the _keys property, it's internal to twig.js</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;_keys&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

                        <span class="nx">loop</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span>  <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
                    <span class="p">});</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Only allow else statements if no output was generated</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">continue_chain</span> <span class="o">=</span> <span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">continue_chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endif %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfor</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endfor$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Set type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% set key = expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">set</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^set\s+([a-zA-Z0-9_,\s]+)\s*=\s*(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">(),</span>
                    <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">expression_stack</span>  <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                    <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression_stack</span><span class="p">;</span>

                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">continue_chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>set on both the global and local context</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="nx">context</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">continue_chain</span><span class="p">,</span>
                    <span class="nx">context</span><span class="o">:</span> <span class="nx">context</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Filter logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% filter upper %} or {% filter lower|escape %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^filter\s+(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfilter</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">unfiltered</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">stack</span> <span class="o">=</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">unfiltered</span>
                    <span class="p">}].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End filter logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endfilter %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfilter</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endfilter$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Block logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% block title %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">block</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^block\s+([a-zA-Z0-9_]+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endblock</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">block</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">block_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="nx">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="nx">hasParent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">placeholders</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Don't override previous blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">hasParent</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">block_output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">])</span>
                    <span class="p">},</span> <span class="nx">context</span><span class="p">]);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">hasParent</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">]</span> <span class="o">=</span>  <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">placeholders</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">block_output</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">]</span> <span class="o">=</span> <span class="nx">block_output</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>This is the base template -> append to output</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">extend</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Check if a child block has been set from a template extending this one.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">output</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">child</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">];</span>

                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">output</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End filter logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endfilter %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endblock</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endblock$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Block logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% extends &quot;template.twig&quot; %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extends_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^extends\s+(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span>   <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Resolve filename</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Set parent template</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">file</span><span class="p">;</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Block logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% extends &quot;template.twig&quot; %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">use</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^use\s+(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Resolve filename</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Import blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">importBlocks</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Block logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% includes &quot;template.twig&quot; [with {some: &#39;values&#39;} only] %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">include</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^include\s+(ignore missing\s+)?(.+?)\s*(?:with\s+(.+?))?\s*(only)?$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">,</span>
                    <span class="nx">includeMissing</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">,</span>
                    <span class="nx">expression</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">(),</span>
                    <span class="nx">withContext</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                    <span class="nx">only</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">;</span>

                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">only</span> <span class="o">=</span> <span class="nx">only</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">includeMissing</span> <span class="o">=</span> <span class="nx">includeMissing</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">withContext</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">withStack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">withContext</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
                    <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Resolve filename</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">innerContext</span> <span class="o">=</span> <span class="p">{},</span>
                    <span class="nx">withContext</span><span class="p">,</span>
                    <span class="nx">i</span><span class="p">,</span>
                    <span class="nx">template</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">.</span><span class="nx">only</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
                            <span class="nx">innerContext</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">withStack</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">withContext</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">withStack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>

                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">withContext</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">withContext</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
                            <span class="nx">innerContext</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">withContext</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">innerContext</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Import file</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">template</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">importFile</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">template</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">innerContext</span><span class="p">)</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="cm">/**</span>
<span class="cm">     * Registry for logic handlers.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Define a new token type, available at Twig.logic.type.{type}</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extendType</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">||</span> <span class="p">(</span><span class="s2">&quot;Twig.logic.type&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">);</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Extend the logic parsing functionality with a new token definition.</span>
<span class="cm">     *</span>
<span class="cm">     * // Define a new tag</span>
<span class="cm">     * Twig.logic.extend({</span>
<span class="cm">     *     type: Twig.logic.type.{type},</span>
<span class="cm">     *     // The pattern to match for this token</span>
<span class="cm">     *     regex: ...,</span>
<span class="cm">     *     // What token types can follow this token, leave blank if any.</span>
<span class="cm">     *     next: [ ... ]</span>
<span class="cm">     *     // Create and return compiled version of the token</span>
<span class="cm">     *     compile: function(token) { ... }</span>
<span class="cm">     *     // Parse the compiled token with the context provided by the render call</span>
<span class="cm">     *     //   and whether this token chain is complete.</span>
<span class="cm">     *     parse: function(token, context, chain) { ... }</span>
<span class="cm">     * });</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} definition The new logic expression.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to extend logic definition. No type provided for &quot;</span> <span class="o">+</span> <span class="nx">definition</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to extend logic definitions. Type &quot;</span> <span class="o">+</span>
                                 <span class="nx">definition</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot; is already defined.&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extendType</span><span class="p">(</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Extend with built-in expressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Compile a logic token into an object ready for parsing.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} raw_token An uncompiled logic token.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} A compiled logic token, ready for parsing.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">raw_token</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">raw_token</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">expression</span><span class="p">]),</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Check if the token needs compiling</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">]);</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.logic.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiled logic token to &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Tokenize logic expressions. This function matches token expressions against regular</span>
<span class="cm">     * expressions provided in token definitions provided with Twig.logic.extend.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} expression the logic token expression to tokenize</span>
<span class="cm">     *                (i.e. what&#39;s between {% and %})</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} The matched token with type set to the token type and match to the regex match.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">tokenize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">token_template_type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">token_type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">token_regex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">regex_array</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">regex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">match</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Ignore whitespace around expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">token_template_type</span> <span class="k">in</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">token_template_type</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Get the type and regex for this template type</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token_type</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token_template_type</span><span class="p">].</span><span class="nx">type</span><span class="p">;</span>
                <span class="nx">token_regex</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token_template_type</span><span class="p">].</span><span class="nx">regex</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Handle multiple regular expressions per type.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">regex_array</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">token_regex</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">regex_array</span> <span class="o">=</span> <span class="nx">token_regex</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">regex_array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token_regex</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Check regular expressions in the order they were specified in the definition.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span><span class="nx">regex_array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">regex</span> <span class="o">=</span> <span class="nx">regex_array</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                    <span class="nx">match</span> <span class="o">=</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">type</span>  <span class="o">=</span> <span class="nx">token_type</span><span class="p">;</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span>
                        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.logic.tokenize: &quot;</span><span class="p">,</span> <span class="s2">&quot;Matched a &quot;</span><span class="p">,</span> <span class="nx">token_type</span><span class="p">,</span> <span class="s2">&quot; regular expression of &quot;</span><span class="p">,</span> <span class="nx">match</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>No regex matches</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to parse &#39;&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Parse a logic token within a given context.</span>
<span class="cm">     *</span>
<span class="cm">     * What are logic chains?</span>
<span class="cm">     *      Logic chains represent a series of tokens that are connected,</span>
<span class="cm">     *          for example:</span>
<span class="cm">     *          {% if ... %} {% else %} {% endif %}</span>
<span class="cm">     *</span>
<span class="cm">     *      The chain parameter is used to signify if a chain is open of closed.</span>
<span class="cm">     *      open:</span>
<span class="cm">     *          More tokens in this chain should be parsed.</span>
<span class="cm">     *      closed:</span>
<span class="cm">     *          This token chain has completed parsing and any additional</span>
<span class="cm">     *          tokens (else, elseif, etc...) should be ignored.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} token The compiled token.</span>
<span class="cm">     * @param {Object} context The render context.</span>
<span class="cm">     * @param {boolean} chain Is this an open logic chain. If false, that means a</span>
<span class="cm">     *                        chain is closed and no further cases should be parsed.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="nx">token_template</span><span class="p">;</span>

        <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="p">{</span> <span class="p">};</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.logic.parse: &quot;</span><span class="p">,</span> <span class="s2">&quot;Parsing logic token &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>

        <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span> <span class="o">=</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 